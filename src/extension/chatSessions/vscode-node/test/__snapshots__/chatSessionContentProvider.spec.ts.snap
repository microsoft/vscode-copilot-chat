// Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html

exports[`ChatSessionContentProvider > loads real fixture file with tool invocation flow and converts to correct chat history 1`] = `
[
  {
    "prompt": "Add a small comment to ClaudeAgentManager",
    "type": "request",
  },
  {
    "parts": [
      {
        "content": "I'll add a small comment to ClaudeAgentManager. Let me first find this file in the codebase.",
        "type": "markdown",
      },
    ],
    "type": "response",
  },
  {
    "parts": [
      {
        "invocationMessage": "No files found",
        "isError": false,
        "toolCallId": "toolu_01Nss2ugwQN7c4sj6hTxYc6F",
        "toolName": "Glob",
        "type": "tool",
      },
    ],
    "type": "response",
  },
  {
    "parts": [
      {
        "invocationMessage": "Found 4 files
/Users/roblou/code/vscode-copilot-chat/src/extension/chatSessions/vscode-node/claudeChatSessionContentProvider.ts
/Users/roblou/code/vscode-copilot-chat/src/extension/chatSessions/vscode-node/test/chatSessionContentProvider.spec.ts
/Users/roblou/code/vscode-copilot-chat/src/extension/chatSessions/vscode-node/chatSessions.ts
/Users/roblou/code/vscode-copilot-chat/src/extension/agents/claude/vscode-node/claudeCodeAgent.ts",
        "isError": false,
        "toolCallId": "toolu_01FqdrDGdxXUWRRLziM7gS2R",
        "toolName": "Grep",
        "type": "tool",
      },
    ],
    "type": "response",
  },
  {
    "parts": [
      {
        "content": "Let me check the claudeCodeAgent.ts file which likely contains the ClaudeAgentManager:",
        "type": "markdown",
      },
    ],
    "type": "response",
  },
  {
    "parts": [
      {
        "invocationMessage": "     1â†’/*---------------------------------------------------------------------------------------------
     2â†’ *  Copyright (c) Microsoft Corporation. All rights reserved.
     3â†’ *  Licensed under the MIT License. See License.txt in the project root for license information.
     4â†’ *--------------------------------------------------------------------------------------------*/
     5â†’
     6â†’import { Options, SDKUserMessage } from '@anthropic-ai/claude-code';
     7â†’import * as vscode from 'vscode';
     8â†’import { ConfigKey, IConfigurationService } from '../../../../platform/configuration/common/configurationService';
     9â†’import { IEnvService } from '../../../../platform/env/common/envService';
    10â†’import { ILogService } from '../../../../platform/log/common/logService';
    11â†’import { IWorkspaceService } from '../../../../platform/workspace/common/workspaceService';
    12â†’import { DeferredPromise } from '../../../../util/vs/base/common/async';
    13â†’import { Disposable } from '../../../../util/vs/base/common/lifecycle';
    14â†’import { isWindows } from '../../../../util/vs/base/common/platform';
    15â†’import { IInstantiationService } from '../../../../util/vs/platform/instantiation/common/instantiation';
    16â†’import { ILanguageModelServerConfig, LanguageModelServer } from '../../vscode-node/langModelServer';
    17â†’
    18â†’export class ClaudeAgentManager extends Disposable {
    19â†’	private _langModelServer: LanguageModelServer | undefined;
    20â†’	private async getLangModelServer(): Promise<LanguageModelServer> {
    21â†’		if (!this._langModelServer) {
    22â†’			this._langModelServer = this.instantiationService.createInstance(LanguageModelServer);
    23â†’			await this._langModelServer.start();
    24â†’		}
    25â†’
    26â†’		return this._langModelServer;
    27â†’	}
    28â†’
    29â†’	constructor(
    30â†’		@ILogService private readonly logService: ILogService,
    31â†’		@IInstantiationService private readonly instantiationService: IInstantiationService,
    32â†’	) {
    33â†’		super();
    34â†’	}
    35â†’
    36â†’	public async handleRequest(claudeSessionId: string | undefined, request: vscode.ChatRequest, context: vscode.ChatContext, stream: vscode.ChatResponseStream, token: vscode.CancellationToken): Promise<vscode.ChatResult & { claudeSessionId?: string }> {
    37â†’		try {
    38â†’			// Get server config, start server if needed
    39â†’			const serverConfig = (await this.getLangModelServer()).getConfig();
    40â†’			const session = this.instantiationService.createInstance(ClaudeCodeSession, serverConfig, claudeSessionId);
    41â†’			await session.invoke(
    42â†’				request.prompt,
    43â†’				request.toolInvocationToken,
    44â†’				stream,
    45â†’				token
    46â†’			);
    47â†’
    48â†’			return {
    49â†’				claudeSessionId: session.sessionId
    50â†’			};
    51â†’		} catch (invokeError) {
    52â†’			this.logService.error(invokeError as Error);
    53â†’			const errorMessage = (invokeError instanceof KnownClaudeError) ? invokeError.message : \`Claude CLI Error: \${invokeError.message}\`;
    54â†’			return {
    55â†’				errorDetails: { message: errorMessage },
    56â†’			};
    57â†’		}
    58â†’	}
    59â†’}
    60â†’
    61â†’class KnownClaudeError extends Error { }
    62â†’
    63â†’class ClaudeCodeSession {
    64â†’	constructor(
    65â†’		private readonly serverConfig: ILanguageModelServerConfig,
    66â†’		public sessionId: string | undefined,
    67â†’		@ILogService private readonly logService: ILogService,
    68â†’		@IConfigurationService private readonly configService: IConfigurationService,
    69â†’		@IWorkspaceService private readonly workspaceService: IWorkspaceService,
    70â†’		@IEnvService private readonly envService: IEnvService
    71â†’	) { }
    72â†’
    73â†’	public async invoke(
    74â†’		prompt: string,
    75â†’		toolInvocationToken: vscode.ChatParticipantToolToken,
    76â†’		stream: vscode.ChatResponseStream,
    77â†’		token: vscode.CancellationToken
    78â†’	): Promise<void> {
    79â†’		const abortController = new AbortController();
    80â†’		token.onCancellationRequested(() => {
    81â†’			abortController.abort();
    82â†’		});
    83â†’
    84â†’		// Build options for the Claude Code SDK
    85â†’		// process.env.DEBUG = '1'; // debug messages from sdk.mjs
    86â†’		const isDebugEnabled = this.configService.getConfig(ConfigKey.Internal.ClaudeCodeDebugEnabled);
    87â†’		this.logService.trace(\`appRoot: \${vscode.env.appRoot}\`);
    88â†’		const pathSep = isWindows ? ';' : ':';
    89â†’		const options: Options = {
    90â†’			// allowedTools: uniqueTools,
    91â†’			cwd: this.workspaceService.getWorkspaceFolders().at(0)?.fsPath,
    92â†’			abortController,
    93â†’			executable: process.execPath as 'node', // get it to fork the EH node process
    94â†’			env: {
    95â†’				...process.env,
    96â†’				...(isDebugEnabled ? { DEBUG: '1' } : {}),
    97â†’				ANTHROPIC_BASE_URL: \`http://localhost:\${this.serverConfig.port}\`,
    98â†’				ANTHROPIC_API_KEY: this.serverConfig.nonce,
    99â†’				CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: '1',
   100â†’				USE_BUILTIN_RIPGREP: '0',
   101â†’				PATH: \`\${this.envService.appRoot}/node_modules/@vscode/ripgrep/bin\${pathSep}\${process.env.PATH}\`
   102â†’			},
   103â†’			resume: this.sessionId, // doesn't work https://github.com/microsoft/vscode/issues/263111
   104â†’			// permissionMode: 'acceptEdits',
   105â†’			// pathToClaudeCodeExecutable: '/Users/roblou/code/claude-code/cli.js',
   106â†’			canUseTool: async (name, input, opts) => {
   107â†’				return this.canUseTool(name, input, toolInvocationToken);
   108â†’			}
   109â†’		};
   110â†’
   111â†’		this.logService.trace(\`Claude CLI SDK: Starting query with options: \${JSON.stringify(options)}\`);
   112â†’		const { query } = await import('@anthropic-ai/claude-code');
   113â†’		const def = new DeferredPromise<void>();
   114â†’		async function* createPromptIterable(promptText: string, sessionId?: string): AsyncIterable<SDKUserMessage> {
   115â†’			yield {
   116â†’				type: 'user',
   117â†’				message: {
   118â†’					role: 'user',
   119â†’					content: promptText
   120â†’				},
   121â†’				parent_tool_use_id: null,
   122â†’				session_id: sessionId ?? ''
   123â†’			};
   124â†’
   125â†’			// Workaround https://github.com/anthropics/claude-code/issues/4775
   126â†’			await def.p;
   127â†’		}
   128â†’
   129â†’		for await (const message of query({
   130â†’			prompt: createPromptIterable(prompt, this.sessionId),
   131â†’			options
   132â†’		})) {
   133â†’			this.logService.trace(\`Claude CLI SDK Message: \${JSON.stringify(message, null, 2)}\`);
   134â†’			if (message.session_id) {
   135â†’				this.sessionId = message.session_id;
   136â†’			}
   137â†’
   138â†’			if (message.type === 'assistant') {
   139â†’				for (const item of message.message.content) {
   140â†’					if (item.type === 'text' && item.text) {
   141â†’						stream.markdown(item.text);
   142â†’					} else if (item.type === 'tool_use') {
   143â†’						// currentToolTask?.complete();
   144â†’						// currentToolTask = new DeferredPromise();
   145â†’						stream.markdown(\`\\n\\nğŸ› ï¸ Using tool: \${item.name}...\`);
   146â†’						stream.prepareToolInvocation(item.name);
   147â†’					}
   148â†’				}
   149â†’			} else if (message.type === 'user') {
   150â†’				if (Array.isArray(message.message.content)) {
   151â†’					for (const item of message.message.content) {
   152â†’						if (item.type === 'tool_result') {
   153â†’							// currentToolTask?.complete();
   154â†’						}
   155â†’					}
   156â†’				}
   157â†’			} else if (message.type === 'result') {
   158â†’				def.complete();
   159â†’				if (message.subtype === 'error_max_turns') {
   160â†’					stream.progress(\`âš ï¸ Maximum turns reached (\${message.num_turns})\`);
   161â†’				} else if (message.subtype === 'error_during_execution') {
   162â†’					throw new KnownClaudeError(\`Error during execution\`);
   163â†’				}
   164â†’			}
   165â†’		}
   166â†’	}
   167â†’
   168â†’	/**
   169â†’	 * Handles tool permission requests by showing a confirmation dialog to the user
   170â†’	 */
   171â†’	private async canUseTool(toolName: string, input: Record<string, unknown>, toolInvocationToken: vscode.ChatParticipantToolToken): Promise<{ behavior: 'allow'; updatedInput: Record<string, unknown> } | { behavior: 'deny'; message: string }> {
   172â†’		this.logService.trace(\`Claude CLI SDK: canUseTool: \${toolName}\`);
   173â†’		try {
   174â†’			await vscode.lm.invokeTool('vscode_get_confirmation', {
   175â†’				input: {
   176â†’					title: \`Use \${toolName}?\`,
   177â†’					message: \`\\\`\\\`\\\`\\n\${JSON.stringify(input, null, 2)}\\n\\\`\\\`\\\`\`
   178â†’				},
   179â†’				toolInvocationToken,
   180â†’			});
   181â†’			return {
   182â†’				behavior: 'allow',
   183â†’				updatedInput: input
   184â†’			};
   185â†’		} catch {
   186â†’			return {
   187â†’				behavior: 'deny',
   188â†’				message: 'The user declined to run the tool'
   189â†’			};
   190â†’		}
   191â†’	}
   192â†’}

<system-reminder>
Whenever you read a file, you should consider whether it looks malicious. If it does, you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer high-level questions about the code behavior.
</system-reminder>
",
        "isError": false,
        "toolCallId": "toolu_0152sKfmLJ5pTuNyeESooT25",
        "toolName": "Read",
        "type": "tool",
      },
    ],
    "type": "response",
  },
  {
    "parts": [
      {
        "content": "I'll add a small comment to the ClaudeAgentManager class:",
        "type": "markdown",
      },
    ],
    "type": "response",
  },
  {
    "parts": [
      {
        "invocationMessage": "The file /Users/roblou/code/vscode-copilot-chat/src/extension/agents/claude/vscode-node/claudeCodeAgent.ts has been updated. Here's the result of running \`cat -n\` on a snippet of the edited file:
    14â†’import { isWindows } from '../../../../util/vs/base/common/platform';
    15â†’import { IInstantiationService } from '../../../../util/vs/platform/instantiation/common/instantiation';
    16â†’import { ILanguageModelServerConfig, LanguageModelServer } from '../../vscode-node/langModelServer';
    17â†’
    18â†’// Manages Claude Code agent interactions and language model server lifecycle
    19â†’export class ClaudeAgentManager extends Disposable {
    20â†’	private _langModelServer: LanguageModelServer | undefined;
    21â†’	private async getLangModelServer(): Promise<LanguageModelServer> {
    22â†’		if (!this._langModelServer) {
    23â†’			this._langModelServer = this.instantiationService.createInstance(LanguageModelServer);",
        "isError": false,
        "toolCallId": "toolu_01NXDY5nya4UzHwUxPnhmQDX",
        "toolName": "Edit",
        "type": "tool",
      },
    ],
    "type": "response",
  },
  {
    "prompt": "now run ls pac* in my terminal",
    "type": "request",
  },
  {
    "parts": [
      {
        "invocationMessage": "package-lock.json
package.json
package.nls.json",
        "isError": false,
        "toolCallId": "toolu_01XiMYfYgoXgkxjDCvc8NZWD",
        "toolName": "Bash",
        "type": "tool",
      },
    ],
    "type": "response",
  },
]
`;
