/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

import type * as vscode from 'vscode';
import { URI } from '../../../util/vs/base/common/uri';
import { IBuildPromptContext } from '../../prompt/common/intents';
import { ToolName } from './toolNames';

// Some environments for this repo don't include the default `console` lib in
// the TypeScript compilation target. Provide a minimal local declaration so
// we can log during tests and runtime checks without altering tsconfig.
declare const console: { log: (...args: any[]) => void; warn: (...args: any[]) => void };

export interface IEditFilterData {
	title: string;
	message: string;
}

export enum CopilotToolMode {
	/**
	 * Give a shorter result, agent mode can call again to get more context
	*/
	PartialContext,

	/**
	 * Give a longer result, it gets one shot
	 */
	FullContext,
}

export interface ICopilotTool<T> extends vscode.LanguageModelTool<T> {
	/**
	 * Called when edits are made in a tool call response. The tool can return
	 * a confirmation that will be shown to the user before edits are applied.
	 */
	filterEdits?(resource: URI): Promise<IEditFilterData | undefined>;

	/**
	 * Called when the tool is referenced in a prompt. If this function is not
	 * provided, Copilot will ask the model to generate the necessary input.
	 */
	provideInput?(promptContext: IBuildPromptContext): Promise<T | undefined>;

	/**
	 * If set, called when the tool is selected in the tool calling loop. Can
	 * resolve LLM-generated input by adding properties or modifying generated
	 * ones.
	 * @param input Input that may have been generated by the model
	 * @param mode The mode in which the tool is being invoked
	 */
	resolveInput?(input: T, promptContext: IBuildPromptContext, mode: CopilotToolMode): Promise<T>;

	/**
	 * Optionally get a programmatic override for the LM tool information. This
	 * can be driven by EXP for example. ⚠️ A tool using an alternative
	 * definition MUST still accept its default parameters because the
	 * alternative definition will only be applied within the Copilot extension,
	 * not other extensions' usages via `vscode.lm.tools`.
	 */
	alternativeDefinition?(): vscode.LanguageModelToolInformation | undefined;
}

export interface ICopilotToolCtor {
	readonly toolName: ToolName;
	new(...args: any[]): ICopilotTool<any>;
}

export const ToolRegistry = new class {
	private _tools: ICopilotToolCtor[] = [];

	public registerTool(tool: ICopilotToolCtor) {
		// Check for duplicate tool names to avoid collisions
		if (this._tools.some(t => t.toolName === tool.toolName)) {
			// Duplicate tool name detected - warn to help debugging registration issues
			console.warn(`[ToolRegistry] Duplicate tool name detected: ${String(tool.toolName)}`);
		}
		this._tools.push(tool);
	}

	public getTools(): readonly ICopilotToolCtor[] {
		return this._tools;
	}

	/**
	 * Dump registered tools to console for debugging
	 */
	public dump(): void {
		console.log('[ToolRegistry] Registered tools:', this._tools.map(t => t.toolName));
	}
}();
